<!DOCTYPE html>
<html>
<head>
    <title>The World of Elyndor</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1E170F;
        }
        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
        #sidebar {
            width: 300px;
            height: 100%;
            overflow: auto;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-right: 2px solid #34495e;
            transition: transform 0.3s ease;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            box-shadow: 3px 0px 10px rgba(0,0,0,0.5);
        }
        #sidebar.hidden {
            display: none;
        }
        #toggleSidebar {
            position: absolute;
            top: 15px;
            left: 10px;
            z-index: 1000;
            background: #34495e;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
        }
        .leaflet-top.leaflet-left {
            left: 10px; /* shift controls off the sidebar */
        }
        /* fixed-size player avatar */
        .circular-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            object-fit: cover;
        }
        /* fixed-size army portrait */
        .portrait-icon {
            width: 16px;
            height: 20px;
            object-fit: cover;
        }
        h2, h3 {
            font-family: 'Fantasy', cursive;
        }
        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
        }
        input, select, textarea {
            width: calc(100% - 30px);
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            background: white;
            color: #333;
        }
        label {
            margin: 5px 0;
        }
        #sidebar h2, #sidebar h3 {
            color: #ecf0f1;
        }
        .readonly #markerForm,
        .readonly #startPolygonDraw {
            display: none;
        }
        .collapsible {
            background-color: #34495e;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }
        .collapsible:after {
            content: '\002B';
            color: white;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .collapsible.active:after {
            content: '\2212';
        }
        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #2c3e50;
        }
        .content.show {
            display: block;
        }
    </style>
</head>
<body>
    <button id="toggleSidebar" style="display:none;">‚ò∞</button>
    <div id="sidebar" class="hidden">
        <input type="text" id="searchInput" placeholder="Search markers..." oninput="searchMarkers()">
        <button type="button" class="collapsible">Marker Management</button>
        <div class="content">
            <form id="markerForm">
                <label for="markerType">Type:</label><br>
                <select id="markerType" onchange="toggleFields();">
                    <option value="player">Player</option>
                    <option value="town">Town</option>
                    <option value="poi">POI</option>
                    <option value="army">Army</option>
                </select><br>
                <label for="markerName">Name:</label><br>
                <input type="text" id="markerName"><br>
                <div id="iconFields">
                    <label for="markerIcon">Icon URL:</label><br>
                    <input type="text" id="markerIcon"><br>
                    <input type="file" id="markerIconFile" accept="image/*"><br>
                </div>
                <div id="townFields" style="display: none;">
                    <label for="townSize">Town Size:</label><br>
                    <select id="townSize">
                        <option value="capital">Capital (‚≠ê)</option>
                        <option value="city">City (‚ö´)</option>
                        <option value="village">Village (üîµ)</option>
                    </select><br>
                </div>
                <div id="armyFields" style="display: none;">
                    <label for="armyNation">Nation:</label><br>
                    <input type="text" id="armyNation"><br>
                    <label for="armyUnitType">Unit Type:</label><br>
                    <input type="text" id="armyUnitType"><br>
                    <label for="armyAttack">Attack:</label><br>
                    <input type="number" id="armyAttack"><br>
                    <label for="armyDefend">Defend:</label><br>
                    <input type="number" id="armyDefend"><br>
                    <label for="armyActionPoints">Action Points:</label><br>
                    <input type="number" id="armyActionPoints"><br>
                    <label for="armyRange">Range:</label><br>
                    <input type="number" id="armyRange"><br>
                    <label for="armyMovement">Movement:</label><br>
                    <input type="number" id="armyMovement"><br>
                    <label for="armyAP1">AP1:</label><br>
                    <input type="text" id="armyAP1"><br>
                    <label for="armyAP2">AP2:</label><br>
                    <input type="text" id="armyAP2"><br>
                    <label for="armyAP3">AP3:</label><br>
                    <input type="text" id="armyAP3"><br>
                    <label for="armyAbilityDesc">Ability Desc:</label><br>
                    <textarea id="armyAbilityDesc" rows="2"></textarea><br>
                </div>
                <label for="markerTooltipType">Tooltip Type:</label><br>
                <select id="markerTooltipType" onchange="toggleTooltipFields()">
                    <option value="image">Image</option>
                    <option value="text">Text</option>
                </select><br>
                <label for="markerTooltip">Tooltip Content:</label><br>
                <input type="text" id="markerTooltip"><br>
                <input type="file" id="markerTooltipFile" accept="image/*" style="display:none;"><br>
                <label for="markerAdminOnly">Admin Only:</label>
                <input type="checkbox" id="markerAdminOnly"><br>
                <button type="button" onclick="addMarker()">Add Marker</button>
            </form>
        </div>

        <button type="button" class="collapsible">Town and POI Markers</button>
        <div class="content">
            <h3>Markers:</h3>
            <ul id="markerList"></ul>
        </div>

        <button type="button" class="collapsible">Player Markers</button>
        <div class="content">
            <h3>Markers:</h3>
            <ul id="playerMarkerList"></ul>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        (function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCo9QPVrLCXS6li_kcTu3e-GOoiiwpHvLs",
                authDomain: "woe-world.firebaseapp.com",
                databaseURL: "https://woe-world-default-rtdb.firebaseio.com",
                projectId: "woe-world",
                storageBucket: "woe-world.appspot.com",
                messagingSenderId: "706865712365",
                appId: "1:706865712365:web:e080b1ef45b8d8b27190e4",
                measurementId: "G-789BN2WECG"
            };
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const storage = firebase.storage();

            // Custom game map image
            const imageUrl = 'assets/high_res_image.png';
            const imageBounds = [[0, 0], [3996, 5729]];

            // Initialize the map
            const map = L.map('map', {
                crs: L.CRS.Simple,
                maxZoom: 2,
                minZoom: -2
            });
            L.imageOverlay(imageUrl, imageBounds).addTo(map);
            map.fitBounds(imageBounds);

            let markers = {};
            let hasEditPermissions = false;

            // Cache DOM elements
            const markerForm              = document.getElementById('markerForm');
            const markerTypeSelect        = document.getElementById('markerType');
            const markerNameInput         = document.getElementById('markerName');
            const markerIconInput         = document.getElementById('markerIcon');
            const markerIconFileInput     = document.getElementById('markerIconFile');
            const markerTooltipTypeSelect = document.getElementById('markerTooltipType');
            const markerTooltipInput      = document.getElementById('markerTooltip');
            const markerTooltipFileInput  = document.getElementById('markerTooltipFile');
            const markerAdminOnlyCheckbox = document.getElementById('markerAdminOnly');
            const townSizeSelect          = document.getElementById('townSize');
            const armyNationInput         = document.getElementById('armyNation');
            const armyUnitTypeInput       = document.getElementById('armyUnitType');
            const armyAttackInput         = document.getElementById('armyAttack');
            const armyDefendInput         = document.getElementById('armyDefend');
            const armyActionPointsInput   = document.getElementById('armyActionPoints');
            const armyRangeInput          = document.getElementById('armyRange');
            const armyMovementInput       = document.getElementById('armyMovement');
            const armyAP1Input            = document.getElementById('armyAP1');
            const armyAP2Input            = document.getElementById('armyAP2');
            const armyAP3Input            = document.getElementById('armyAP3');
            const armyAbilityDescInput    = document.getElementById('armyAbilityDesc');
            const sidebar                 = document.getElementById('sidebar');
            const toggleSidebarBtn        = document.getElementById('toggleSidebar');
            const markerList              = document.getElementById('markerList');
            const playerMarkerList        = document.getElementById('playerMarkerList');
            const searchInput             = document.getElementById('searchInput');
            const coll                    = document.getElementsByClassName("collapsible");

            function toggleFields() {
                const t = markerTypeSelect.value;
                document.getElementById('iconFields').style.display = (t==='player'||t==='army')?'block':'none';
                document.getElementById('townFields').style.display = (t==='town')?'block':'none';
                document.getElementById('armyFields').style.display = (t==='army')?'block':'none';
                toggleTooltipFields();
            }
            function toggleTooltipFields() {
                const tt = markerTooltipTypeSelect.value, t = markerTypeSelect.value;
                markerTooltipInput.style.display     = (tt==='text' && t!=='player' && t!=='army')?'block':'none';
                markerTooltipFileInput.style.display = (tt==='image'||t==='player'||t==='army')?'block':'none';
            }

            database.ref('markers').on('value', snap => {
                const data = snap.val()||{};
                Object.keys(data).forEach(id => {
                    const d = correctMarkerData(data[id]);
                    if (!isValidMarkerData(d)) {
                        database.ref('markers/'+id).remove();
                    } else if (markers[id]) {
                        const m = markers[id], ll = L.latLng(d.lat,d.lng);
                        if (!m.getLatLng().equals(ll)) m.setLatLng(ll);
                    } else {
                        createMarker(id,d);
                    }
                });
            });

            function correctMarkerData(data) {
                const defs = { type:'unknown', lat:0,lng:0,name:'Unnamed Marker',
                               iconUrl:'assets/placeholder.png',
                               tooltipType:'text',tooltipContent:'',adminOnly:false };
                return {...defs, ...data};
            }
            function isValidMarkerData(d) {
                return ['type','lat','lng','name'].every(f=>d[f]!=null);
            }

            async function addMarker() {
                const type   = markerTypeSelect.value;
                const name   = markerNameInput.value;
                let   iconUrl = markerIconInput.value;
                const tt     = markerTooltipTypeSelect.value;
                let   tooltip = markerTooltipInput.value;
                const admin  = markerAdminOnlyCheckbox.checked;
                const id     = database.ref().child('markers').push().key;

                let opts = { id, lat: map.getCenter().lat, lng: map.getCenter().lng,
                             name, type, iconUrl, tooltipType:tt, tooltipContent:tooltip, adminOnly:admin };

                const iconFile = markerIconFileInput.files[0];
                if (iconFile && (type==='player'||type==='army')) {
                    const ref = storage.ref(`markers/${id}/icon`);
                    const s   = await ref.put(iconFile);
                    iconUrl   = await s.ref.getDownloadURL();
                    opts.iconUrl = iconUrl;
                }
                const tipFile = markerTooltipFileInput.files[0];
                if (tipFile && tt==='image') {
                    const ref = storage.ref(`markers/${id}/tooltip`);
                    const s   = await ref.put(tipFile);
                    tooltip   = await s.ref.getDownloadURL();
                    opts.tooltipContent = tooltip;
                }

                if (type==='town') {
                    opts.size = townSizeSelect.value;
                }
                if (type==='army') {
                    opts = {
                        ...opts,
                        nation:       armyNationInput.value,
                        unitType:     armyUnitTypeInput.value,
                        attack:       armyAttackInput.value,
                        defend:       armyDefendInput.value,
                        actionPoints: armyActionPointsInput.value,
                        range:        armyRangeInput.value,
                        movement:     armyMovementInput.value,
                        ap1:          armyAP1Input.value,
                        ap2:          armyAP2Input.value,
                        ap3:          armyAP3Input.value,
                        abilityDesc:  armyAbilityDescInput.value
                    };
                }

                await database.ref('markers/'+id).set(opts);
                createMarker(id,opts);
                resetMarkerForm();
            }

            function createMarker(id,d) {
                if (markers[id]) map.removeLayer(markers[id]);
                if (!hasEditPermissions && d.adminOnly) return;

                let m;
                switch(d.type) {
                    case 'player': m = createPlayerMarker(d); break;
                    case 'town':
                    case 'poi':    m = createTownOrPoiMarker(d); break;
                    case 'army':   m = createArmyMarker(d); break;
                    default:
                        database.ref('markers/'+id).remove();
                        return;
                }
                m.on('dragend', e => {
                    const ll = e.target.getLatLng();
                    database.ref('markers/'+id).update({lat:ll.lat,lng:ll.lng});
                });
                m.on('click', () => {
                    if (hasEditPermissions) {
                        showSidebar();
                        map.panTo(m.getLatLng());
                    }
                });
                markers[id] = m.addTo(map);
                updateSidebar();
            }

            function createPlayerMarker(d) {
                const icon = L.icon({
                    iconUrl: d.iconUrl,
                    iconSize: [16,16],
                    className: 'circular-icon'
                });
                const m = L.marker([d.lat,d.lng], { icon, draggable: hasEditPermissions });
                if (d.tooltipType==='image') {
                    m.bindPopup(`<div style="font-size:16px;">
                                 <strong>${d.name}</strong><br>
                                 <img src="${d.tooltipContent}" width="200"><br>
                                 ${getAdminOptions(d)}</div>`);
                } else {
                    m.bindPopup(`<div style="font-size:16px;">
                                 <strong>${d.name}</strong><br>
                                 ${d.tooltipContent}<br>
                                 ${getAdminOptions(d)}</div>`);
                }
                return m;
            }

            function createTownOrPoiMarker(d) {
                const html = d.type==='town'
                           ? (d.size==='capital'?'‚≠ê':d.size==='city'?'‚ö´':'üîµ')
                           : '‚ùì';
                const m = L.marker([d.lat,d.lng], {
                    icon: L.divIcon({ html, className:'custom-div-icon' }),
                    draggable: hasEditPermissions
                });
                if (d.tooltipType==='image') {
                    m.bindPopup(`<div style="font-size:16px;">
                                 <strong>${d.name}</strong><br>
                                 <img src="${d.tooltipContent}" width="200"><br>
                                 ${getAdminOptions(d)}</div>`);
                } else {
                    m.bindPopup(`<div style="font-size:16px;">
                                 <strong>${d.name}</strong><br>
                                 ${d.tooltipContent}<br>
                                 ${getAdminOptions(d)}</div>`);
                }
                return m;
            }

            function createArmyMarker(d) {
                const icon = L.icon({
                    iconUrl: d.iconUrl,
                    iconSize: [16,20],
                    className: 'portrait-icon'
                });
                const m = L.marker([d.lat,d.lng], { icon, draggable: hasEditPermissions });
                const html = `<div style="font-size:16px;">
                              <strong>${d.name}</strong><br>
                              <img src="${d.iconUrl}" width="16" height="20"><br>
                              <strong>Nation:</strong> ${d.nation}<br>
                              <strong>Unit Type:</strong> ${d.unitType}<br>
                              <strong>Attack:</strong> ${d.attack}<br>
                              <strong>Defend:</strong> ${d.defend}<br>
                              <strong>Action Points:</strong> ${d.actionPoints}<br>
                              <strong>Range:</strong> ${d.range}<br>
                              <strong>Movement:</strong> ${d.movement}<br>
                              <strong>AP1:</strong> ${d.ap1}<br>
                              <strong>AP2:</strong> ${d.ap2}<br>
                              <strong>AP3:</strong> ${d.ap3}<br>
                              <strong>Ability Desc:</strong> ${d.abilityDesc}<br>
                              ${getAdminOptions(d)}
                              </div>`;
                m.bindPopup(html);
                return m;
            }

            function getAdminOptions(d) {
                if (!hasEditPermissions) return '';
                return `<button onclick="duplicateMarker('${d.id}')">Duplicate</button>
                        <input type="checkbox" ${d.adminOnly?'checked':''}
                               onchange="toggleAdminOnly('${d.id}',this.checked)"> Admin Only`;
            }

            function duplicateMarker(id) {
                const m = markers[id];
                const opts = {
                    ...m.options,
                    id: database.ref().child('markers').push().key,
                    lat: m.getLatLng().lat,
                    lng: m.getLatLng().lng,
                    type: m.options.type || 'unknown'
                };
                database.ref('markers/'+opts.id).set(opts);
                createMarker(opts.id, opts);
            }

            function toggleAdminOnly(id, val) {
                database.ref('markers/'+id).update({adminOnly: val});
                markers[id].options.adminOnly = val;
                if (!hasEditPermissions && val) {
                    map.removeLayer(markers[id]);
                } else if (hasEditPermissions && !map.hasLayer(markers[id])) {
                    markers[id].addTo(map);
                }
                updateSidebar();
            }

            function resetMarkerForm() {
                markerForm.reset();
                toggleFields();
            }

            function updateSidebar() {
                markerList.innerHTML = '';
                playerMarkerList.innerHTML = '';
                const q = searchInput.value.toLowerCase();
                Object.keys(markers).forEach(id => {
                    const m = markers[id];
                    const content = m.getPopup().getContent();
                    const name = content.match(/<strong>(.*?)<\/strong>/)[1];
                    if (!name.toLowerCase().includes(q)) return;
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${name}</strong>` +
                                   (hasEditPermissions
                                     ? `<button onclick="editMarker('${id}')">Edit</button>
                                        <button onclick="removeMarker('${id}')">Remove</button>`
                                     : '');
                    if (m.options.type==='player') playerMarkerList.appendChild(li);
                    else markerList.appendChild(li);
                });
            }

            function searchMarkers() { updateSidebar(); }

            function editMarker(id) {
                const m = markers[id];
                const pop = m.getPopup().getContent();
                const name = pop.match(/<strong>(.*?)<\/strong>/)[1];
                const newName = prompt('Enter new name:', name);
                let newTooltip = '';
                if (pop.includes('<img')) {
                    const url = pop.match(/<img src="(.*?)"/)[1];
                    newTooltip = prompt('Enter new image URL:', url);
                } else {
                    const txt = pop.replace(/<[^>]+>/g,'').split('\n')[1].trim();
                    newTooltip = prompt('Enter new tooltip text:', txt);
                }
                const adminOnly = confirm('Make admin only?');
                database.ref('markers/'+id).update({
                    name: newName,
                    tooltipContent: newTooltip,
                    adminOnly
                });
                if (pop.includes('<img')) {
                    m.setPopupContent(`<div style="font-size:16px;">
                                       <strong>${newName}</strong><br>
                                       <img src="${newTooltip}" width="200"></div>`);
                } else {
                    m.setPopupContent(`<div style="font-size:16px;">
                                       <strong>${newName}</strong><br>
                                       ${newTooltip}</div>`);
                }
                updateSidebar();
            }

            function removeMarker(id) {
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
                database.ref('markers/'+id).remove();
                updateSidebar();
            }

            function checkIPAccess() {
                fetch('https://api.ipify.org?format=json')
                    .then(r => r.json())
                    .then(data => {
                        const allowedIPs = ['24.57.218.92','98.16.223.9'];
                        hasEditPermissions = allowedIPs.includes(data.ip);
                        document.body.classList.toggle('readonly', !hasEditPermissions);
                        sidebar.classList.toggle('hidden', !hasEditPermissions);
                        toggleSidebarBtn.style.display = hasEditPermissions ? 'block' : 'none';
                        Object.values(markers).forEach(m => {
                            if (hasEditPermissions) m.dragging.enable();
                            else m.dragging.disable();
                        });
                    })
                    .catch(console.error);
            }
            checkIPAccess();

            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                const hidden = sidebar.classList.contains('hidden');
                toggleSidebarBtn.style.left = hidden ? '10px' : '310px';
                document.querySelector('.leaflet-top.leaflet-left').style.left = hidden ? '10px' : '320px';
                map.invalidateSize();
            });

            function showSidebar() {
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    toggleSidebarBtn.style.left = '310px';
                    document.querySelector('.leaflet-top.leaflet-left').style.left = '320px';
                    map.invalidateSize();
                }
            }

            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    this.nextElementSibling.classList.toggle("show");
                });
            }

            window.removeMarker      = removeMarker;
            window.editMarker        = editMarker;
            window.toggleFields      = toggleFields;
            window.addMarker         = addMarker;
            window.searchMarkers     = searchMarkers;
            window.duplicateMarker   = duplicateMarker;
            window.toggleAdminOnly   = toggleAdminOnly;

            toggleFields();
        })();
    </script>
</body>
</html>
